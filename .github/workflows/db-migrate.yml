name: DB Migrate (Supabase)
on:
  workflow_dispatch: {}

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure psql client
        run: |
          if ! command -v psql >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y postgresql-client
          fi

      - name: Run migration (force IPv4, fallback 6543â†’5432)
        env:
          PGCONNECT_TIMEOUT: "10"
        run: |
          set -e
          FILE="supabase/migrations/20251025_init_dewrk.sql"
          test -f "$FILE" || { echo "Migration file missing: $FILE"; exit 2; }

          URL1='postgresql://postgres:Yasin.4545.95@db.ngnxebpzlbhqjmwtfcjy.supabase.co:6543/postgres?sslmode=require'
          URL2='postgresql://postgres:Yasin.4545.95@db.ngnxebpzlbhqjmwtfcjy.supabase.co:5432/postgres?sslmode=require'

          echo "Trying IPv4 to 6543..."
          if psql -4 "$URL1" -c 'select 1;' ; then
            echo "Connected on 6543. Applying migration..."
            psql -4 "$URL1" -f "$FILE"
            exit 0
          fi

          echo "6543 failed. Trying IPv4 to 5432..."
          if psql -4 "$URL2" -c 'select 1;' ; then
            echo "Connected on 5432. Applying migration..."
            psql -4 "$URL2" -f "$FILE"
            exit 0
          fi

          echo "All connection attempts failed (IPv4 6543 & 5432)."
          exit 2
